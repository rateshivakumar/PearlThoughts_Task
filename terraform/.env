#!/bin/bash
set -e

# update and install basics
apt-get update -y
apt-get upgrade -y
apt-get install -y git curl build-essential nginx

# install node v20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs

# install pm2 globally
npm install -g pm2

# clone application
cd /opt
git clone "${repo_url}" app || { echo "git clone failed"; exit 1; }
cd app
# if backend directory specified (starter layout)
if [ -d "${app_dir}" ]; then
  cd ${app_dir}
fi

# create .env for Strapi (Postgres)
cat > .env <<EOF
HOST=0.0.0.0
PORT=1337
DATABASE_CLIENT=postgres
DATABASE_HOST=${db_host}
DATABASE_PORT=5432
DATABASE_NAME=${db_name}
DATABASE_USERNAME=${db_user}
DATABASE_PASSWORD=${db_password}
AWS_BUCKET=${s3_bucket}
# set STRAPI_UPLOADS_PROVIDER env later if using provider plugin
EOF

# install dependencies
npm install --unsafe-perm

# build admin for production
export NODE_ENV=production
npm run build

# start app with pm2
pm2 start npm --name strapi -- run start
pm2 save
pm2 startup systemd -u ubuntu --hp /home/ubuntu || true

# configure nginx reverse proxy
cat > /etc/nginx/sites-available/strapi <<'NGINX'
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    location / {
        proxy_pass http://127.0.0.1:1337/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
NGINX

ln -sf /etc/nginx/sites-available/strapi /etc/nginx/sites-enabled/strapi
nginx -t && systemctl restart nginx

